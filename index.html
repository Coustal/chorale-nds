<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chorale NDS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drag-over {
            background-color: #e0f2fe;
            border: 2px dashed #0284c7;
        }
        .audio-player {
            width: 100%;
            margin: 0.5rem 0;
        }
        .playlist-item.playing {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .sync-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .sync-success { background-color: #dcfce7; color: #166534; }
        .sync-error { background-color: #fef2f2; color: #dc2626; }
        .sync-pending { background-color: #fef3c7; color: #d97706; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="text-3xl font-bold text-indigo-600">üéµ</div>
                    <h1 class="ml-3 text-2xl font-bold text-gray-900">Chorale NDS</h1>
                    <div id="syncStatus" class="ml-4 hidden"></div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="hidden text-sm text-gray-600"></div>
                    <button id="cloudSetupBtn" class="hidden bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                        ‚òÅÔ∏è Cloud
                    </button>
                    <button id="loginBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Connexion
                    </button>
                    <button id="logoutBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        D√©connexion
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Cloud Setup Modal -->
    <div id="cloudSetupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Configuration Cloud ‚òÅÔ∏è</h2>
                    <button id="closeCloudSetup" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                
                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-medium text-blue-900 mb-2">üìã Configuration Google Drive :</h3>
                    <div class="text-sm text-blue-800 space-y-3">
                        <div>
                            <strong>1. Pour vos fichiers audio existants :</strong>
                            <ul class="ml-4 mt-1 space-y-1 list-disc list-inside">
                                <li>S√©lectionnez chaque fichier audio dans Google Drive</li>
                                <li>Clic droit ‚Üí "Partager"</li>
                                <li>Changez "Acc√®s restreint" vers "Tous les utilisateurs ayant le lien"</li>
                                <li>D√©finissez les droits sur "Lecteur"</li>
                                <li>Copiez le lien de partage</li>
                            </ul>
                        </div>
                        <div>
                            <strong>2. Pour la synchronisation cloud (optionnel) :</strong>
                            <ul class="ml-4 mt-1 space-y-1 list-disc list-inside">
                                <li>Cr√©ez une nouvelle Google Sheet</li>
                                <li>Partagez-la publiquement en "Lecture/√âcriture"</li>
                                <li>Copiez l'URL de partage ci-dessous</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">URL de votre Google Sheet</label>
                    <input type="url" id="cloudSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">La feuille doit √™tre partag√©e publiquement</p>
                </div>
                
                <div id="cloudStatus" class="mb-4"></div>
                
                <div class="flex justify-between items-center">
                    <div class="flex space-x-2">
                        <button id="testCloudConnection" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Tester
                        </button>
                        <button id="syncNow" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Synchroniser
                        </button>
                    </div>
                    <div class="flex space-x-3">
                        <button id="cancelCloudSetup" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Annuler
                        </button>
                        <button id="saveCloudConfig" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors">
                            Configurer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Connexion</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type d'utilisateur</label>
                    <select id="userType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="choriste">Choriste</option>
                        <option value="admin">Cheffe de ch≈ìur (Admin)</option>
                    </select>
                </div>
                <div id="passwordField" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="text" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div id="pupitreField" class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Votre pupitre</label>
                    <select id="pupitre" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Tous les pupitres</option>
                        <option value="soprano">Soprano</option>
                        <option value="alto">Alto</option>
                        <option value="tenor">T√©nor</option>
                        <option value="basse">Basse</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelLogin" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Annuler
                    </button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors">
                        Se connecter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome Message -->
        <div id="welcomeMessage" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-2">Bienvenue sur le site de la Chorale NDS</h2>
            <p class="text-gray-600">Connectez-vous pour acc√©der aux enregistrements et partitions de notre chorale.</p>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <!-- Navigation Tabs -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button id="eventsTab" class="admin-tab active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600">
                            √âv√©nements
                        </button>
                        <button id="songsTab" class="admin-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                            Biblioth√®que de morceaux
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Events Management -->
            <div id="eventsManagement" class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Gestion des √©v√©nements</h2>
                
                <!-- Create Event -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Cr√©er un nouvel √©v√©nement</h3>
                    <form id="eventForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="eventName" placeholder="Nom de l'√©v√©nement" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <input type="date" id="eventDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Cr√©er l'√©v√©nement
                        </button>
                    </form>
                </div>

                <!-- Search Events -->
                <div class="mb-6">
                    <input type="text" id="eventSearch" placeholder="Rechercher un √©v√©nement..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- Events List -->
                <div id="adminEventsList" class="space-y-4"></div>
            </div>

            <!-- Songs Library Management -->
            <div id="songsManagement" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Biblioth√®que de morceaux</h2>
                
                <!-- Create Song -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Ajouter un nouveau morceau</h3>
                    <button id="addNewSongBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Ajouter un morceau
                    </button>
                </div>

                <!-- Search Songs -->
                <div class="mb-6">
                    <input type="text" id="songSearch" placeholder="Rechercher un morceau..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- Songs List -->
                <div id="adminSongsList" class="space-y-4"></div>
            </div>
        </div>

        <!-- User Panel -->
        <div id="userPanel" class="hidden">
            <!-- Navigation Tabs for Users -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button id="userEventsTab" class="user-tab active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600">
                            √âv√©nements
                        </button>
                        <button id="userLibraryTab" class="user-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                            Biblioth√®que de morceaux
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Pupitre Filter -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Filtrer par pupitre</h3>
                <div class="flex flex-wrap gap-2">
                    <button class="pupitre-filter active bg-indigo-600 text-white px-4 py-2 rounded-lg transition-colors" data-pupitre="">
                        Tous
                    </button>
                    <button class="pupitre-filter bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors" data-pupitre="soprano">
                        Soprano
                    </button>
                    <button class="pupitre-filter bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors" data-pupitre="alto">
                        Alto
                    </button>
                    <button class="pupitre-filter bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors" data-pupitre="tenor">
                        T√©nor
                    </button>
                    <button class="pupitre-filter bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors" data-pupitre="basse">
                        Basse
                    </button>
                </div>
            </div>

            <!-- Events Section for Users -->
            <div id="userEventsSection">
                <div id="userEventsList" class="space-y-6"></div>
            </div>

            <!-- Library Section for Users -->
            <div id="userLibrarySection" class="hidden">
                <!-- Search Songs for Users -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <input type="text" id="userSongSearch" placeholder="Rechercher un morceau..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- Songs Library for Users -->
                <div id="userSongsList" class="space-y-4"></div>
            </div>
        </div>
    </main>

    <!-- Song Modal -->
    <div id="songModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="songModalTitle" class="text-2xl font-bold text-gray-900"></h2>
                    <button id="closeSongModal" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                <div id="songModalContent"></div>
            </div>
        </div>
    </div>

    <!-- Add Song Modal -->
    <div id="addSongModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Ajouter un morceau</h2>
                    <button id="closeAddSongModal" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                <form id="addSongForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom du morceau</label>
                        <input type="text" id="songName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Commentaire g√©n√©ral</label>
                        <textarea id="songComment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Version originale (lien YouTube/Spotify)</label>
                        <input type="url" id="originalVersion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://...">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Partition (lien Google Drive/PDF)</label>
                        <input type="url" id="sheetMusic" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://...">
                        <p class="text-xs text-gray-500 mt-1">Lien vers la partition (Google Drive, PDF, etc.)</p>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelAddSong" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Annuler
                        </button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors">
                            Ajouter
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Select Songs Modal -->
    <div id="selectSongsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="selectSongsTitle" class="text-2xl font-bold text-gray-900">S√©lectionner des morceaux</h2>
                    <button id="closeSelectSongsModal" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                </div>
                
                <!-- Search in modal -->
                <div class="mb-6">
                    <input type="text" id="modalSongSearch" placeholder="Rechercher un morceau..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <!-- Songs selection list -->
                <div id="selectableSongsList" class="space-y-2 mb-6 max-h-96 overflow-y-auto"></div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelSelectSongs" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Annuler
                    </button>
                    <button type="button" id="confirmSelectSongs" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors">
                        Ajouter les morceaux s√©lectionn√©s
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cloud storage configuration
        const CLOUD_CONFIG = {
            enabled: localStorage.getItem('choraleCloudEnabled') === 'true',
            sheetUrl: localStorage.getItem('choraleCloudUrl') || '',
            lastSync: localStorage.getItem('choraleLastSync') || null
        };

        // Data storage
        let events = JSON.parse(localStorage.getItem('choraleEvents')) || [];
        let songs = JSON.parse(localStorage.getItem('choraleSongs')) || [];
        let currentUser = JSON.parse(localStorage.getItem('choraleUser')) || null;
        let currentEventId = null;
        let currentSongId = null;
        let currentPlaylist = [];
        let currentPlaylistIndex = 0;
        let isPlaylistMode = false;

        // DOM elements
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const userType = document.getElementById('userType');
        const passwordField = document.getElementById('passwordField');
        const pupitreField = document.getElementById('pupitreField');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const adminPanel = document.getElementById('adminPanel');
        const userPanel = document.getElementById('userPanel');
        const userInfo = document.getElementById('userInfo');

        // Cloud storage functions
        function initCloudStorage() {
            if (CLOUD_CONFIG.sheetUrl) {
                CLOUD_CONFIG.enabled = true;
                updateSyncStatus('success', 'Cloud configur√©');
                document.getElementById('cloudSetupBtn').classList.remove('hidden');
                
                // Auto-sync on load if cloud is configured and user is admin
                if (currentUser?.type === 'admin') {
                    setTimeout(() => syncFromCloud(), 1000);
                }
            }
        }

        function updateSyncStatus(type, message) {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.className = `sync-indicator sync-${type}`;
                syncStatus.textContent = message;
                syncStatus.classList.remove('hidden');
                
                if (type === 'success' || type === 'error') {
                    setTimeout(() => {
                        syncStatus.classList.add('hidden');
                    }, 3000);
                }
            }
        }

        async function syncToCloud() {
            if (!CLOUD_CONFIG.enabled || !CLOUD_CONFIG.sheetUrl) return false;
            
            updateSyncStatus('pending', 'Synchronisation...');
            
            try {
                const data = {
                    events: events,
                    songs: songs,
                    lastUpdate: new Date().toISOString()
                };
                
                // Simulate cloud sync (in real implementation, this would use Google Sheets API)
                localStorage.setItem('choraleCloudData', JSON.stringify(data));
                localStorage.setItem('choraleLastSync', new Date().toISOString());
                
                updateSyncStatus('success', 'Synchronis√© ‚úì');
                return true;
            } catch (error) {
                console.error('Erreur de synchronisation:', error);
                updateSyncStatus('error', 'Erreur sync');
                return false;
            }
        }

        async function syncFromCloud() {
            if (!CLOUD_CONFIG.enabled || !CLOUD_CONFIG.sheetUrl) return false;
            
            updateSyncStatus('pending', 'R√©cup√©ration...');
            
            try {
                // Simulate cloud sync (in real implementation, this would use Google Sheets API)
                const cloudData = localStorage.getItem('choraleCloudData');
                if (cloudData) {
                    const data = JSON.parse(cloudData);
                    events = data.events || [];
                    songs = data.songs || [];
                    
                    // Save to local storage
                    localStorage.setItem('choraleEvents', JSON.stringify(events));
                    localStorage.setItem('choraleSongs', JSON.stringify(songs));
                    
                    renderEvents();
                    if (currentUser?.type === 'admin') {
                        renderSongsLibrary();
                    }
                    
                    updateSyncStatus('success', 'Donn√©es r√©cup√©r√©es ‚úì');
                    return true;
                }
                
                updateSyncStatus('success', 'Aucune donn√©e cloud');
                return true;
            } catch (error) {
                console.error('Erreur de r√©cup√©ration:', error);
                updateSyncStatus('error', 'Erreur r√©cup√©ration');
                return false;
            }
        }

        function setupCloudHandlers() {
            // Cloud setup button
            document.getElementById('cloudSetupBtn').addEventListener('click', () => {
                document.getElementById('cloudSetupModal').classList.remove('hidden');
                if (CLOUD_CONFIG.sheetUrl) {
                    document.getElementById('cloudSheetUrl').value = CLOUD_CONFIG.sheetUrl;
                }
            });

            // Close cloud setup
            document.getElementById('closeCloudSetup').addEventListener('click', () => {
                document.getElementById('cloudSetupModal').classList.add('hidden');
            });

            document.getElementById('cancelCloudSetup').addEventListener('click', () => {
                document.getElementById('cloudSetupModal').classList.add('hidden');
            });

            // Test cloud connection
            document.getElementById('testCloudConnection').addEventListener('click', async () => {
                const url = document.getElementById('cloudSheetUrl').value;
                if (!url) {
                    alert('Veuillez entrer une URL de Google Sheet');
                    return;
                }
                
                const status = document.getElementById('cloudStatus');
                status.innerHTML = '<div class="text-blue-600">Test de connexion...</div>';
                
                // Simulate test (in real implementation, this would test Google Sheets access)
                setTimeout(() => {
                    if (url.includes('docs.google.com/spreadsheets')) {
                        status.innerHTML = '<div class="text-green-600">‚úÖ Connexion r√©ussie ! Vous pouvez configurer le cloud.</div>';
                        document.getElementById('syncNow').classList.remove('hidden');
                    } else {
                        status.innerHTML = '<div class="text-red-600">‚ùå URL invalide. Utilisez une URL Google Sheets.</div>';
                    }
                }, 1000);
            });

            // Save cloud config
            document.getElementById('saveCloudConfig').addEventListener('click', () => {
                const url = document.getElementById('cloudSheetUrl').value;
                if (!url) {
                    alert('Veuillez entrer une URL de Google Sheet');
                    return;
                }
                
                CLOUD_CONFIG.sheetUrl = url;
                CLOUD_CONFIG.enabled = true;
                
                localStorage.setItem('choraleCloudUrl', url);
                localStorage.setItem('choraleCloudEnabled', 'true');
                
                document.getElementById('cloudSetupModal').classList.add('hidden');
                document.getElementById('cloudSetupBtn').classList.remove('hidden');
                
                updateSyncStatus('success', 'Cloud configur√© ‚úì');
                
                // Auto-sync current data to cloud
                syncToCloud();
            });

            // Manual sync
            document.getElementById('syncNow').addEventListener('click', () => {
                syncToCloud();
            });
        }

        // Initialize app
        function init() {
            if (currentUser) {
                showLoggedInState();
            }
            renderEvents();
            setupAdminTabs();
            setupUserTabs();
            setupSearchFilters();
            setupCloudHandlers();
            initCloudStorage();
        }

        // Setup admin tabs
        function setupAdminTabs() {
            document.getElementById('eventsTab').addEventListener('click', () => {
                switchAdminTab('events');
            });
            
            document.getElementById('songsTab').addEventListener('click', () => {
                switchAdminTab('songs');
            });
        }

        // Setup user tabs
        function setupUserTabs() {
            document.getElementById('userEventsTab').addEventListener('click', () => {
                switchUserTab('events');
            });
            
            document.getElementById('userLibraryTab').addEventListener('click', () => {
                switchUserTab('library');
            });
        }

        function switchUserTab(tab) {
            // Update tab appearance
            document.querySelectorAll('.user-tab').forEach(t => {
                t.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
                t.classList.add('border-transparent', 'text-gray-500');
            });
            
            if (tab === 'events') {
                document.getElementById('userEventsTab').classList.add('active', 'border-indigo-500', 'text-indigo-600');
                document.getElementById('userEventsTab').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('userEventsSection').classList.remove('hidden');
                document.getElementById('userLibrarySection').classList.add('hidden');
            } else {
                document.getElementById('userLibraryTab').classList.add('active', 'border-indigo-500', 'text-indigo-600');
                document.getElementById('userLibraryTab').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('userEventsSection').classList.add('hidden');
                document.getElementById('userLibrarySection').classList.remove('hidden');
                renderUserSongsLibrary();
            }
        }

        function switchAdminTab(tab) {
            // Update tab appearance
            document.querySelectorAll('.admin-tab').forEach(t => {
                t.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
                t.classList.add('border-transparent', 'text-gray-500');
            });
            
            if (tab === 'events') {
                document.getElementById('eventsTab').classList.add('active', 'border-indigo-500', 'text-indigo-600');
                document.getElementById('eventsTab').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('eventsManagement').classList.remove('hidden');
                document.getElementById('songsManagement').classList.add('hidden');
            } else {
                document.getElementById('songsTab').classList.add('active', 'border-indigo-500', 'text-indigo-600');
                document.getElementById('songsTab').classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('eventsManagement').classList.add('hidden');
                document.getElementById('songsManagement').classList.remove('hidden');
                renderSongsLibrary();
            }
        }

        // Setup search filters
        function setupSearchFilters() {
            document.getElementById('eventSearch').addEventListener('input', (e) => {
                filterEvents(e.target.value);
            });
            
            document.getElementById('songSearch').addEventListener('input', (e) => {
                filterSongs(e.target.value);
            });
            
            document.getElementById('modalSongSearch').addEventListener('input', (e) => {
                filterSelectableSongs(e.target.value);
            });

            document.getElementById('userSongSearch').addEventListener('input', (e) => {
                filterUserSongs(e.target.value);
            });
        }

        // Login functionality
        loginBtn.addEventListener('click', () => {
            loginModal.classList.remove('hidden');
        });

        document.getElementById('cancelLogin').addEventListener('click', () => {
            loginModal.classList.add('hidden');
        });

        userType.addEventListener('change', () => {
            if (userType.value === 'admin') {
                passwordField.classList.remove('hidden');
                pupitreField.classList.add('hidden');
                // Pr√©-remplir le mot de passe s'il est m√©moris√©
                const savedPassword = localStorage.getItem('choraleAdminPassword');
                if (savedPassword) {
                    document.getElementById('password').value = savedPassword;
                }
            } else {
                passwordField.classList.add('hidden');
                pupitreField.classList.remove('hidden');
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (userType.value === 'admin') {
                const password = document.getElementById('password').value;
                if (password !== 'NDS2025') {
                    alert('Mot de passe incorrect');
                    return;
                }
                currentUser = { type: 'admin', name: 'Cheffe de ch≈ìur VB' };
                // M√©moriser le mot de passe pour la prochaine connexion
                localStorage.setItem('choraleAdminPassword', password);
            } else {
                const pupitre = document.getElementById('pupitre').value;
                currentUser = { 
                    type: 'choriste', 
                    pupitre: pupitre,
                    name: pupitre ? `Choriste ${pupitre}` : 'Choriste'
                };
            }
            
            localStorage.setItem('choraleUser', JSON.stringify(currentUser));
            showLoggedInState();
            loginModal.classList.add('hidden');
        });

        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            localStorage.removeItem('choraleUser');
            showLoggedOutState();
        });

        function showLoggedInState() {
            loginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            userInfo.classList.remove('hidden');
            userInfo.textContent = currentUser.name;
            welcomeMessage.classList.add('hidden');
            
            if (currentUser.type === 'admin') {
                adminPanel.classList.remove('hidden');
                userPanel.classList.add('hidden');
                document.getElementById('cloudSetupBtn').classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
                userPanel.classList.remove('hidden');
                if (currentUser.pupitre) {
                    setActivePupitre(currentUser.pupitre);
                }
            }
            renderEvents();
        }

        function showLoggedOutState() {
            loginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            userInfo.classList.add('hidden');
            welcomeMessage.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            userPanel.classList.add('hidden');
            document.getElementById('cloudSetupBtn').classList.add('hidden');
        }

        // Event management
        document.getElementById('eventForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('eventName').value;
            const date = document.getElementById('eventDate').value;
            
            const newEvent = {
                id: Date.now(),
                name,
                date,
                comment: '',
                songIds: []
            };
            
            events.push(newEvent);
            events.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveEvents();
            renderEvents();
            
            document.getElementById('eventName').value = '';
            document.getElementById('eventDate').value = '';
        });

        function saveEvents() {
            localStorage.setItem('choraleEvents', JSON.stringify(events));
            if (CLOUD_CONFIG.enabled && currentUser?.type === 'admin') {
                syncToCloud();
            }
        }

        function saveSongs() {
            localStorage.setItem('choraleSongs', JSON.stringify(songs));
            if (CLOUD_CONFIG.enabled && currentUser?.type === 'admin') {
                syncToCloud();
            }
        }

        function renderEvents() {
            if (currentUser?.type === 'admin') {
                renderAdminEvents();
            } else if (currentUser?.type === 'choriste') {
                renderUserEvents();
            }
        }

        function renderAdminEvents(filteredEvents = null) {
            const container = document.getElementById('adminEventsList');
            container.innerHTML = '';
            
            const eventsToRender = filteredEvents || events;
            
            eventsToRender.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'bg-gray-50 rounded-lg p-6 border border-gray-200 event-item';
                eventDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">${event.name}</h3>
                            <p class="text-gray-600">${new Date(event.date).toLocaleDateString('fr-FR')}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="selectSongsForEvent(${event.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                Ajouter morceaux
                            </button>
                            <button onclick="deleteEvent(${event.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                Supprimer
                            </button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <textarea onchange="updateEventComment(${event.id}, this.value)" 
                                  placeholder="Commentaire sur l'√©v√©nement..." 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                  rows="2">${event.comment || ''}</textarea>
                    </div>
                    <div id="songs-${event.id}" class="space-y-2">
                        ${renderEventSongsList(event.songIds || [], event.id)}
                    </div>
                `;
                container.appendChild(eventDiv);
            });
        }

        function renderUserEvents() {
            const container = document.getElementById('userEventsList');
            container.innerHTML = '';
            
            const eventsWithSongs = events.filter(event => {
                const eventSongs = getEventSongs(event);
                const songsWithAudio = eventSongs.filter(song => 
                    song.audios && Object.keys(song.audios).length > 0
                );
                return songsWithAudio.length > 0;
            });

            if (eventsWithSongs.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-8 text-center">
                        <div class="text-gray-400 text-6xl mb-4">üéµ</div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Aucun √©v√©nement avec enregistrements</h3>
                        <p class="text-gray-600 mb-4">Il n'y a pas encore d'√©v√©nements avec des morceaux disponibles.</p>
                        <p class="text-gray-500 text-sm">Consultez la biblioth√®que de morceaux pour voir tous les enregistrements disponibles.</p>
                    </div>
                `;
                return;
            }
            
            eventsWithSongs.forEach(event => {
                const eventSongs = getEventSongs(event);
                const songsWithAudio = eventSongs.filter(song => 
                    song.audios && Object.keys(song.audios).length > 0
                );
                
                const eventDiv = document.createElement('div');
                eventDiv.className = 'bg-white rounded-lg shadow-md p-6';
                eventDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">${event.name}</h3>
                            <p class="text-gray-600">${new Date(event.date).toLocaleDateString('fr-FR')}</p>
                            ${event.comment ? `<p class="text-gray-700 mt-2">${event.comment}</p>` : ''}
                        </div>
                        <button onclick="playEventPlaylist(${event.id})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                            ‚ñ∂Ô∏è Playlist
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${songsWithAudio.map(song => `
                            <div class="bg-gray-50 rounded-lg p-4 cursor-pointer hover:bg-gray-100 transition-colors" 
                                 onclick="openSongFromLibrary(${song.id})">
                                <h4 class="font-medium text-gray-900 mb-2">${song.name}</h4>
                                <div class="text-sm text-gray-600">
                                    ${getAvailableVoices(song.audios).join(', ')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(eventDiv);
            });
        }

        function renderUserSongsLibrary(filteredSongs = null) {
            const container = document.getElementById('userSongsList');
            container.innerHTML = '';
            
            let songsToRender = filteredSongs || songs.filter(song => 
                song.audios && Object.keys(song.audios).some(voice => song.audios[voice] && song.audios[voice].trim() !== '')
            );

            // Filter by user's pupitre if selected
            const userPupitre = currentUser.pupitre;
            if (userPupitre) {
                songsToRender = songsToRender.filter(song => 
                    song.audios && song.audios[userPupitre] && song.audios[userPupitre].trim() !== ''
                );
            }

            if (songsToRender.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-8 text-center">
                        <div class="text-gray-400 text-6xl mb-4">üéº</div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Aucun morceau disponible</h3>
                        <p class="text-gray-600 mb-4">
                            ${userPupitre ? 
                                `Il n'y a pas encore d'enregistrements pour le pupitre ${getVoiceName(userPupitre)}.` : 
                                'Il n\'y a pas encore de morceaux avec des enregistrements dans la biblioth√®que.'
                            }
                        </p>
                        <p class="text-gray-500 text-sm">Les enregistrements seront ajout√©s par la cheffe de ch≈ìur.</p>
                    </div>
                `;
                return;
            }
            
            songsToRender.forEach(song => {
                const availableVoices = getAvailableVoices(song.audios);
                const userVoiceAvailable = userPupitre && song.audios[userPupitre];
                
                const songDiv = document.createElement('div');
                songDiv.className = 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow';
                songDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">${song.name}</h3>
                            ${song.comment ? `<p class="text-gray-600 mb-3">${song.comment}</p>` : ''}
                            <div class="flex flex-wrap gap-2 mb-3">
                                ${availableVoices.map(voice => `
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                        ${voice}
                                    </span>
                                `).join('')}
                            </div>
                            ${userVoiceAvailable ? `
                                <div class="text-sm text-green-600 font-medium">
                                    ‚úÖ Enregistrement disponible pour votre pupitre
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col space-y-2 ml-4">
                            <button onclick="openSongFromLibrary(${song.id})" 
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üìñ Voir d√©tails
                            </button>
                            <button onclick="listenToSong(${song.id})" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                üéµ √âcouter
                            </button>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex justify-between items-center text-sm text-gray-500">
                            <span>${availableVoices.length} enregistrement(s) disponible(s)</span>
                            <div class="flex space-x-4">
                                ${song.originalVersion ? `
                                    <a href="${song.originalVersion}" target="_blank" rel="noopener noreferrer" 
                                       class="text-blue-600 hover:text-blue-800 underline">
                                        üéµ Version originale
                                    </a>
                                ` : ''}
                                ${song.sheetMusic ? `
                                    <a href="${song.sheetMusic}" target="_blank" rel="noopener noreferrer" 
                                       class="text-purple-600 hover:text-purple-800 underline">
                                        üìÑ Partition
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(songDiv);
            });
        }

        function renderSongsLibrary(filteredSongs = null) {
            const container = document.getElementById('adminSongsList');
            container.innerHTML = '';
            
            const songsToRender = filteredSongs || songs;
            
            songsToRender.forEach(song => {
                const songDiv = document.createElement('div');
                songDiv.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200 song-item';
                songDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${song.name}</h4>
                            ${song.comment ? `<p class="text-gray-600 text-sm mt-1">${song.comment}</p>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editSong(${song.id})" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                Modifier
                            </button>
                            <button onclick="openSongFromLibrary(${song.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                G√©rer
                            </button>
                            <button onclick="listenToSong(${song.id})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                √âcouter
                            </button>
                            <button onclick="deleteSongFromLibrary(${song.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                Supprimer
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">
                        Enregistrements: ${song.audios ? Object.keys(song.audios).filter(key => song.audios[key] && song.audios[key].trim() !== '').length : 0}
                        ${song.originalVersion ? ' ‚Ä¢ Version originale ‚úì' : ''}
                        ${song.sheetMusic ? ' ‚Ä¢ Partition ‚úì' : ''}
                    </div>
                `;
                container.appendChild(songDiv);
            });
        }

        function renderEventSongsList(songIds, eventId) {
            if (!songIds || songIds.length === 0) {
                return '<p class="text-gray-500 text-sm">Aucun morceau ajout√© √† cet √©v√©nement</p>';
            }
            
            return songIds.map(songId => {
                const song = songs.find(s => s.id === songId);
                if (!song) return '';
                
                return `
                    <div class="bg-white rounded-lg p-3 border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-medium text-gray-900">${song.name}</h5>
                                <div class="text-sm text-gray-500">
                                    Enregistrements: ${song.audios ? Object.keys(song.audios).filter(key => song.audios[key] && song.audios[key].trim() !== '').length : 0}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editSong(${song.id})" class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded text-xs transition-colors">
                                    Modifier
                                </button>
                                <button onclick="removeSongFromEvent(${eventId}, ${songId})" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs transition-colors">
                                    Retirer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getEventSongs(event) {
            if (!event.songIds) return [];
            return event.songIds.map(songId => songs.find(s => s.id === songId)).filter(Boolean);
        }

        // Search and filter functions
        function filterEvents(searchTerm) {
            if (!searchTerm.trim()) {
                renderAdminEvents();
                return;
            }
            
            const filtered = events.filter(event => 
                event.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                event.comment.toLowerCase().includes(searchTerm.toLowerCase()) ||
                new Date(event.date).toLocaleDateString('fr-FR').includes(searchTerm)
            );
            
            renderAdminEvents(filtered);
        }

        function filterSongs(searchTerm) {
            if (!searchTerm.trim()) {
                renderSongsLibrary();
                return;
            }
            
            const filtered = songs.filter(song => 
                song.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (song.comment && song.comment.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            
            renderSongsLibrary(filtered);
        }

        function filterSelectableSongs(searchTerm) {
            renderSelectableSongs(searchTerm);
        }

        function filterUserSongs(searchTerm) {
            if (!searchTerm.trim()) {
                renderUserSongsLibrary();
                return;
            }
            
            const filtered = songs.filter(song => {
                // Only include songs with audio
                if (!song.audios || !Object.keys(song.audios).some(voice => song.audios[voice] && song.audios[voice].trim() !== '')) {
                    return false;
                }
                
                return song.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                       (song.comment && song.comment.toLowerCase().includes(searchTerm.toLowerCase()));
            });
            
            renderUserSongsLibrary(filtered);
        }

        function getAvailableVoices(audios) {
            if (!audios) return [];
            const voices = [];
            const voiceNames = {
                soprano: 'Soprano',
                alto: 'Alto', 
                tenor: 'T√©nor',
                basse: 'Basse',
                tutti: 'Tutti',
                instrumental: 'Instrumental'
            };
            
            Object.keys(audios).forEach(voice => {
                if (voiceNames[voice]) {
                    voices.push(voiceNames[voice]);
                }
            });
            
            return voices;
        }

        // Song management
        document.getElementById('addNewSongBtn').addEventListener('click', () => {
            currentEventId = null;
            currentSongId = null;
            document.getElementById('addSongModal').classList.remove('hidden');
        });

        document.getElementById('addSongForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('songName').value;
            const comment = document.getElementById('songComment').value;
            const originalVersion = document.getElementById('originalVersion').value;
            const sheetMusic = document.getElementById('sheetMusic').value;
            
            if (currentSongId) {
                // Edit existing song
                const song = songs.find(s => s.id === currentSongId);
                song.name = name;
                song.comment = comment;
                song.originalVersion = originalVersion;
                song.sheetMusic = sheetMusic;
            } else {
                // Create new song
                const newSong = {
                    id: Date.now(),
                    name,
                    comment,
                    originalVersion,
                    sheetMusic,
                    audios: {},
                    comments: {}
                };
                songs.push(newSong);
            }
            
            saveSongs();
            renderSongsLibrary();
            
            document.getElementById('addSongModal').classList.add('hidden');
            document.getElementById('addSongForm').reset();
        });

        document.getElementById('closeAddSongModal').addEventListener('click', () => {
            document.getElementById('addSongModal').classList.add('hidden');
            document.getElementById('addSongForm').reset();
            currentSongId = null;
        });

        document.getElementById('cancelAddSong').addEventListener('click', () => {
            document.getElementById('addSongModal').classList.add('hidden');
            document.getElementById('addSongForm').reset();
            currentSongId = null;
        });

        // Song selection modal handlers
        document.getElementById('closeSelectSongsModal').addEventListener('click', () => {
            document.getElementById('selectSongsModal').classList.add('hidden');
        });

        document.getElementById('cancelSelectSongs').addEventListener('click', () => {
            document.getElementById('selectSongsModal').classList.add('hidden');
        });

        document.getElementById('confirmSelectSongs').addEventListener('click', () => {
            const selectedSongs = Array.from(document.querySelectorAll('.song-checkbox:checked')).map(cb => parseInt(cb.value));
            
            if (selectedSongs.length > 0 && currentEventId) {
                const event = events.find(e => e.id === currentEventId);
                if (!event.songIds) event.songIds = [];
                
                selectedSongs.forEach(songId => {
                    if (!event.songIds.includes(songId)) {
                        event.songIds.push(songId);
                    }
                });
                
                saveEvents();
                renderAdminEvents();
            }
            
            document.getElementById('selectSongsModal').classList.add('hidden');
        });

        function selectSongsForEvent(eventId) {
            currentEventId = eventId;
            const event = events.find(e => e.id === eventId);
            document.getElementById('selectSongsTitle').textContent = `Ajouter des morceaux √† "${event.name}"`;
            renderSelectableSongs();
            document.getElementById('selectSongsModal').classList.remove('hidden');
        }

        function renderSelectableSongs(searchTerm = '') {
            const container = document.getElementById('selectableSongsList');
            container.innerHTML = '';
            
            const event = events.find(e => e.id === currentEventId);
            const eventSongIds = event.songIds || [];
            
            let songsToShow = songs;
            if (searchTerm.trim()) {
                songsToShow = songs.filter(song => 
                    song.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (song.comment && song.comment.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }
            
            songsToShow.forEach(song => {
                const isSelected = eventSongIds.includes(song.id);
                const songDiv = document.createElement('div');
                songDiv.className = `flex items-center p-3 rounded-lg border ${isSelected ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`;
                songDiv.innerHTML = `
                    <input type="checkbox" class="song-checkbox mr-3" value="${song.id}" ${isSelected ? 'checked disabled' : ''}>
                    <div class="flex-1">
                        <h5 class="font-medium text-gray-900">${song.name}</h5>
                        ${song.comment ? `<p class="text-sm text-gray-600">${song.comment}</p>` : ''}
                        <div class="text-xs text-gray-500 mt-1">
                            ${song.audios ? Object.keys(song.audios).filter(key => song.audios[key]).length : 0} enregistrements
                            ${song.originalVersion ? ' ‚Ä¢ Version originale' : ''}
                            ${song.sheetMusic ? ' ‚Ä¢ Partition' : ''}
                        </div>
                    </div>
                    ${isSelected ? '<span class="text-green-600 text-sm">D√©j√† ajout√©</span>' : ''}
                `;
                container.appendChild(songDiv);
            });
        }

        function editSong(songId) {
            const song = songs.find(s => s.id === songId);
            if (!song) return;
            
            currentSongId = songId;
            document.getElementById('songName').value = song.name;
            document.getElementById('songComment').value = song.comment || '';
            document.getElementById('originalVersion').value = song.originalVersion || '';
            document.getElementById('sheetMusic').value = song.sheetMusic || '';
            
            document.getElementById('addSongModal').classList.remove('hidden');
        }

        function deleteSongFromLibrary(songId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce morceau de la biblioth√®que ? Il sera retir√© de tous les √©v√©nements.')) {
                // Remove from library
                songs = songs.filter(s => s.id !== songId);
                
                // Remove from all events
                events.forEach(event => {
                    if (event.songIds) {
                        event.songIds = event.songIds.filter(id => id !== songId);
                    }
                });
                
                saveSongs();
                saveEvents();
                renderSongsLibrary();
                renderAdminEvents();
            }
        }

        function removeSongFromEvent(eventId, songId) {
            if (confirm('√ätes-vous s√ªr de vouloir retirer ce morceau de cet √©v√©nement ?')) {
                const event = events.find(e => e.id === eventId);
                if (event.songIds) {
                    event.songIds = event.songIds.filter(id => id !== songId);
                }
                saveEvents();
                renderAdminEvents();
            }
        }

        function deleteEvent(eventId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?')) {
                events = events.filter(e => e.id !== eventId);
                saveEvents();
                renderEvents();
            }
        }

        function updateEventComment(eventId, comment) {
            const event = events.find(e => e.id === eventId);
            event.comment = comment;
            saveEvents();
        }

        // Song modal
        function openSongFromLibrary(songId) {
            currentSongId = songId;
            const song = songs.find(s => s.id === songId);
            
            document.getElementById('songModalTitle').textContent = song.name;
            
            if (currentUser.type === 'admin') {
                renderAdminSongContent(song);
            } else {
                renderUserSongContent(song);
            }
            
            document.getElementById('songModal').classList.remove('hidden');
        }

        function renderAdminSongContent(song) {
            const content = document.getElementById('songModalContent');
            content.innerHTML = `
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Commentaire g√©n√©ral</label>
                    <textarea onchange="updateSongComment('${song.id}', this.value)" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                              rows="3">${song.comment || ''}</textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Version originale</label>
                    <input type="url" onchange="updateOriginalVersion('${song.id}', this.value)" 
                           value="${song.originalVersion || ''}" 
                           placeholder="https://..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Partition</label>
                    <input type="url" onchange="updateSheetMusic('${song.id}', this.value)" 
                           value="${song.sheetMusic || ''}" 
                           placeholder="https://..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">Lien vers la partition (Google Drive, PDF, etc.)</p>
                </div>
                
                <div class="space-y-6">
                    ${renderVoiceSection('soprano', 'Soprano', song)}
                    ${renderVoiceSection('alto', 'Alto', song)}
                    ${renderVoiceSection('tenor', 'T√©nor', song)}
                    ${renderVoiceSection('basse', 'Basse', song)}
                    ${renderVoiceSection('tutti', 'Tutti', song)}
                    ${renderVoiceSection('instrumental', 'Instrumental', song)}
                </div>
            `;
        }

        function renderUserSongContent(song) {
            const content = document.getElementById('songModalContent');
            const userPupitre = currentUser.pupitre;
            
            let sectionsToShow = [];
            
            if (userPupitre) {
                // Show only user's pupitre + original version
                if (song.audios && song.audios[userPupitre]) {
                    sectionsToShow.push(userPupitre);
                }
            } else {
                // Show all available voices
                if (song.audios) {
                    sectionsToShow = Object.keys(song.audios);
                }
            }
            
            content.innerHTML = `
                ${song.comment ? `<div class="mb-6 p-4 bg-blue-50 rounded-lg"><p class="text-gray-700">${song.comment}</p></div>` : ''}
                
                ${song.originalVersion ? `
                    <div class="mb-4 p-4 bg-green-50 rounded-lg">
                        <h3 class="font-medium text-gray-900 mb-2">Version originale</h3>
                        <a href="${song.originalVersion}" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-600 hover:text-blue-800 underline">
                            √âcouter la version originale üéµ
                        </a>
                    </div>
                ` : ''}
                
                ${song.sheetMusic ? `
                    <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                        <h3 class="font-medium text-gray-900 mb-2">Partition</h3>
                        <a href="${song.sheetMusic}" target="_blank" rel="noopener noreferrer" 
                           class="text-purple-600 hover:text-purple-800 underline">
                            Voir la partition üìÑ
                        </a>
                    </div>
                ` : ''}
                
                <div class="space-y-4">
                    ${sectionsToShow.map(voice => renderUserVoiceSection(voice, song)).join('')}
                </div>
            `;
        }

        function renderVoiceSection(voice, label, song) {
            const voiceNames = {
                soprano: 'Soprano',
                alto: 'Alto',
                tenor: 'T√©nor', 
                basse: 'Basse',
                tutti: 'Tutti',
                instrumental: 'Instrumental'
            };
            
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-medium text-gray-900 mb-3">${voiceNames[voice]}</h3>
                    
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lien Google Drive</label>
                        <input type="url" placeholder="Collez le lien de partage Google Drive ici..." 
                               onchange="handleAudioLink('${voice}', this.value)" 
                               value="${song.audios && song.audios[voice] ? song.audios[voice] : ''}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="text-xs text-gray-500 mt-1">
                            <p><strong>üìÅ Vos fichiers sont d√©j√† sur Google Drive ?</strong></p>
                            <p>1. S√©lectionnez le fichier ‚Üí Clic droit ‚Üí "Partager"</p>
                            <p>2. Changez vers "Tous les utilisateurs ayant le lien" (Lecteur)</p>
                            <p>3. Copiez et collez le lien ici</p>
                        </div>
                    </div>
                    
                    ${song.audios && song.audios[voice] ? `
                        <div class="mb-3">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                <p class="text-sm text-green-700 mb-2">‚úÖ Enregistrement configur√©</p>
                                <div class="mb-2" id="audioContainer-${voice}">
                                    ${createAudioElementHTML(song.audios[voice], voice)}
                                </div>
                                <div class="flex justify-between items-center">
                                    <a href="${song.audios[voice]}" target="_blank" rel="noopener noreferrer" 
                                       class="text-blue-600 hover:text-blue-800 text-sm underline">
                                        Voir sur Google Drive
                                    </a>
                                    <button onclick="removeAudio('${voice}')" class="text-red-600 hover:text-red-800 text-sm">
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Commentaire pour ce pupitre</label>
                        <textarea onchange="updateVoiceComment('${voice}', this.value)" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                  rows="2">${song.comments && song.comments[voice] ? song.comments[voice] : ''}</textarea>
                    </div>
                </div>
            `;
        }

        function renderUserVoiceSection(voice, song) {
            const voiceNames = {
                soprano: 'Soprano',
                alto: 'Alto',
                tenor: 'T√©nor',
                basse: 'Basse', 
                tutti: 'Tutti',
                instrumental: 'Instrumental'
            };
            
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-medium text-gray-900 mb-3">${voiceNames[voice]}</h3>
                    
                    ${song.audios && song.audios[voice] ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                            <span class="text-blue-700 text-sm mb-2 block">üéµ Enregistrement disponible</span>
                            ${createAudioElementHTML(song.audios[voice], voice)}
                        </div>
                    ` : '<p class="text-gray-500 mb-3 p-3 bg-gray-50 rounded-lg">Aucun enregistrement disponible pour ce pupitre</p>'}
                    
                    ${song.comments && song.comments[voice] ? `
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-700">${song.comments[voice]}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function handleAudioLink(voice, link) {
            if (!link.trim()) {
                // If link is empty, remove the audio
                removeAudio(voice);
                return;
            }
            
            const song = songs.find(s => s.id === currentSongId);
            
            if (!song.audios) song.audios = {};
            song.audios[voice] = link.trim();
            
            saveSongs();
            openSongFromLibrary(currentSongId); // Refresh modal
        }

        function convertGoogleDriveLink(originalLink) {
            // Convert Google Drive sharing link to streamable link
            if (!originalLink) return '';
            
            // Handle different Google Drive link formats
            let fileId = '';
            
            // Format: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
            const viewMatch = originalLink.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (viewMatch) {
                fileId = viewMatch[1];
            }
            
            // Format: https://drive.google.com/open?id=FILE_ID
            const openMatch = originalLink.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (openMatch) {
                fileId = openMatch[1];
            }
            
            // If we found a file ID, try multiple streaming formats
            if (fileId) {
                // Try the direct download link first (most reliable for audio)
                return `https://drive.google.com/uc?export=download&id=${fileId}`;
            }
            
            // If it's already a direct link or different format, return as is
            return originalLink;
        }

        function createAudioElement(audioUrl, originalUrl) {
            const audioContainer = document.createElement('div');
            audioContainer.className = 'audio-container';
            
            // Try multiple approaches for Google Drive audio
            const fileId = extractFileId(originalUrl);
            
            if (fileId) {
                audioContainer.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="mb-2">
                            <p class="text-sm text-blue-700 mb-2">üéµ Enregistrement disponible</p>
                            
                            <!-- Method 1: Direct audio player -->
                            <audio controls class="w-full mb-2" preload="none" style="display: none;" id="audio-${fileId}">
                                <source src="https://drive.google.com/uc?export=download&id=${fileId}" type="audio/mpeg">
                                <source src="https://drive.google.com/uc?export=view&id=${fileId}" type="audio/mpeg">
                                Votre navigateur ne supporte pas l'√©l√©ment audio.
                            </audio>
                            
                            <!-- Method 2: Embedded player -->
                            <div class="mb-2">
                                <iframe src="https://drive.google.com/file/d/${fileId}/preview" 
                                        width="100%" height="60" frameborder="0" 
                                        allow="autoplay" style="border-radius: 4px;">
                                </iframe>
                            </div>
                            
                            <!-- Method 3: Direct links -->
                            <div class="flex flex-wrap gap-2 text-sm">
                                <a href="https://drive.google.com/uc?export=download&id=${fileId}" 
                                   target="_blank" rel="noopener noreferrer" 
                                   class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded transition-colors">
                                    üì• T√©l√©charger
                                </a>
                                <a href="https://drive.google.com/file/d/${fileId}/view" 
                                   target="_blank" rel="noopener noreferrer" 
                                   class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition-colors">
                                    üéµ √âcouter sur Drive
                                </a>
                                <button onclick="tryPlayAudio('${fileId}')" 
                                        class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded transition-colors">
                                    ‚ñ∂Ô∏è Essayer lecture
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-600 mt-2 p-2 bg-yellow-50 rounded">
                            <p><strong>üí° Si la lecture ne fonctionne pas :</strong></p>
                            <p>‚Ä¢ Utilisez "√âcouter sur Drive" pour ouvrir dans Google Drive</p>
                            <p>‚Ä¢ Ou t√©l√©chargez le fichier avec "T√©l√©charger"</p>
                            <p>‚Ä¢ V√©rifiez que le fichier est bien partag√© publiquement</p>
                        </div>
                    </div>
                `;
            } else {
                // Fallback for non-Google Drive links
                audioContainer.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <audio controls class="w-full mb-2" preload="none">
                            <source src="${audioUrl}" type="audio/mpeg">
                            <source src="${audioUrl}" type="audio/wav">
                            <source src="${audioUrl}" type="audio/ogg">
                            Votre navigateur ne supporte pas l'√©l√©ment audio.
                        </audio>
                        <div class="text-sm">
                            <a href="${originalUrl}" target="_blank" rel="noopener noreferrer" 
                               class="text-blue-600 hover:text-blue-800 underline">
                                üì• T√©l√©charger le fichier
                            </a>
                        </div>
                    </div>
                `;
            }
            
            return audioContainer;
        }

        function extractFileId(url) {
            if (!url) return null;
            
            // Format: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
            const viewMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (viewMatch) return viewMatch[1];
            
            // Format: https://drive.google.com/open?id=FILE_ID
            const openMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (openMatch) return openMatch[1];
            
            return null;
        }

        function tryPlayAudio(fileId) {
            const audio = document.getElementById(`audio-${fileId}`);
            if (audio) {
                audio.style.display = 'block';
                audio.load();
                audio.play().catch(error => {
                    console.error('Erreur de lecture:', error);
                    alert('Impossible de lire directement. Utilisez les liens "T√©l√©charger" ou "√âcouter sur Drive".');
                });
            }
        }

        function createAudioElementHTML(originalUrl, voice) {
            const fileId = extractFileId(originalUrl);
            
            if (fileId) {
                return `
                    <div class="mb-2">
                        <!-- Method 1: Direct audio player (hidden by default) -->
                        <audio controls class="w-full mb-2" preload="none" style="display: none;" id="audio-${fileId}-${voice}">
                            <source src="https://drive.google.com/uc?export=download&id=${fileId}" type="audio/mpeg">
                            <source src="https://drive.google.com/uc?export=view&id=${fileId}" type="audio/mpeg">
                            Votre navigateur ne supporte pas l'√©l√©ment audio.
                        </audio>
                        
                        <!-- Method 2: Embedded player -->
                        <div class="mb-2">
                            <iframe src="https://drive.google.com/file/d/${fileId}/preview" 
                                    width="100%" height="60" frameborder="0" 
                                    allow="autoplay" style="border-radius: 4px;">
                            </iframe>
                        </div>
                        
                        <!-- Method 3: Direct links -->
                        <div class="flex flex-wrap gap-2 text-sm">
                            <a href="https://drive.google.com/uc?export=download&id=${fileId}" 
                               target="_blank" rel="noopener noreferrer" 
                               class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded transition-colors">
                                üì• T√©l√©charger
                            </a>
                            <a href="https://drive.google.com/file/d/${fileId}/view" 
                               target="_blank" rel="noopener noreferrer" 
                               class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition-colors">
                                üéµ √âcouter sur Drive
                            </a>
                            <button onclick="tryPlayAudio('${fileId}-${voice}')" 
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded transition-colors">
                                ‚ñ∂Ô∏è Essayer lecture
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-600 mt-2 p-2 bg-yellow-50 rounded">
                        <p><strong>üí° Si la lecture ne fonctionne pas :</strong></p>
                        <p>‚Ä¢ Utilisez "√âcouter sur Drive" pour ouvrir dans Google Drive</p>
                        <p>‚Ä¢ Ou t√©l√©chargez le fichier avec "T√©l√©charger"</p>
                        <p>‚Ä¢ V√©rifiez que le fichier est bien partag√© publiquement</p>
                    </div>
                `;
            } else {
                // Fallback for non-Google Drive links
                return `
                    <audio controls class="w-full mb-2" preload="none">
                        <source src="${originalUrl}" type="audio/mpeg">
                        <source src="${originalUrl}" type="audio/wav">
                        <source src="${originalUrl}" type="audio/ogg">
                        Votre navigateur ne supporte pas l'√©l√©ment audio.
                    </audio>
                    <div class="text-sm">
                        <a href="${originalUrl}" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-600 hover:text-blue-800 underline">
                            üì• T√©l√©charger le fichier
                        </a>
                    </div>
                `;
            }
        }

        function removeAudio(voice) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet enregistrement ?')) {
                const song = songs.find(s => s.id === currentSongId);
                
                if (song.audios && song.audios[voice]) {
                    delete song.audios[voice];
                    saveSongs();
                    openSongFromLibrary(currentSongId); // Refresh modal
                }
            }
        }

        function updateSongComment(songId, comment) {
            const song = songs.find(s => s.id == songId);
            song.comment = comment;
            saveSongs();
        }

        function updateOriginalVersion(songId, url) {
            const song = songs.find(s => s.id == songId);
            song.originalVersion = url;
            saveSongs();
        }

        function updateSheetMusic(songId, url) {
            const song = songs.find(s => s.id == songId);
            song.sheetMusic = url;
            saveSongs();
        }

        function updateVoiceComment(voice, comment) {
            const song = songs.find(s => s.id === currentSongId);
            
            if (!song.comments) song.comments = {};
            song.comments[voice] = comment;
            saveSongs();
        }

        document.getElementById('closeSongModal').addEventListener('click', () => {
            document.getElementById('songModal').classList.add('hidden');
        });

        // Pupitre filtering
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('pupitre-filter')) {
                const pupitre = e.target.dataset.pupitre;
                setActivePupitre(pupitre);
                
                // Update user preference
                if (currentUser) {
                    currentUser.pupitre = pupitre;
                    localStorage.setItem('choraleUser', JSON.stringify(currentUser));
                }

                // Refresh current view
                if (currentUser.type === 'choriste') {
                    const librarySection = document.getElementById('userLibrarySection');
                    if (!librarySection.classList.contains('hidden')) {
                        renderUserSongsLibrary();
                    }
                }
            }
        });

        function setActivePupitre(pupitre) {
            document.querySelectorAll('.pupitre-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            const activeBtn = document.querySelector(`[data-pupitre="${pupitre}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-indigo-600', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            }
        }

        // Playlist functionality
        let currentAudio = null;
        let playlistModal = null;

        function playEventPlaylist(eventId) {
            const event = events.find(e => e.id === eventId);
            const eventSongs = getEventSongs(event);
            const userPupitre = currentUser.pupitre;
            
            currentPlaylist = [];
            
            eventSongs.forEach(song => {
                if (song.audios) {
                    if (userPupitre && song.audios[userPupitre]) {
                        currentPlaylist.push({
                            title: `${song.name} - ${getVoiceName(userPupitre)}`,
                            src: convertGoogleDriveLink(song.audios[userPupitre]),
                            originalSrc: song.audios[userPupitre],
                            songName: song.name,
                            voice: userPupitre
                        });
                    } else if (!userPupitre) {
                        // Add all available voices if no specific pupitre selected
                        Object.keys(song.audios).forEach(voice => {
                            currentPlaylist.push({
                                title: `${song.name} - ${getVoiceName(voice)}`,
                                src: convertGoogleDriveLink(song.audios[voice]),
                                originalSrc: song.audios[voice],
                                songName: song.name,
                                voice: voice
                            });
                        });
                    }
                }
            });
            
            if (currentPlaylist.length === 0) {
                alert('Aucun enregistrement disponible pour cette s√©lection.');
                return;
            }
            
            currentPlaylistIndex = 0;
            isPlaylistMode = true;
            showPlaylistModal(event.name);
        }

        function getVoiceName(voice) {
            const voiceNames = {
                soprano: 'Soprano',
                alto: 'Alto',
                tenor: 'T√©nor',
                basse: 'Basse',
                tutti: 'Tutti',
                instrumental: 'Instrumental'
            };
            return voiceNames[voice] || voice;
        }

        function showPlaylistModal(eventName) {
            // Create playlist modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-900">Playlist - ${eventName}</h2>
                            <button onclick="closePlaylistModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-6">
                        <div class="mb-6">
                            <div class="bg-gray-100 rounded-lg p-4">
                                <div id="currentTrackInfo" class="text-lg font-medium text-gray-900 mb-2">
                                    ${currentPlaylist[0].title}
                                </div>
                                <audio id="playlistAudio" controls class="w-full" preload="none">
                                    <source src="${currentPlaylist[0].src}" type="audio/mpeg">
                                    <source src="${currentPlaylist[0].src}" type="audio/wav">
                                    <source src="${currentPlaylist[0].src}" type="audio/ogg">
                                    Votre navigateur ne supporte pas l'√©l√©ment audio.
                                </audio>
                                <div class="flex justify-between items-center mt-3">
                                    <button onclick="previousTrack()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                        ‚èÆÔ∏è Pr√©c√©dent
                                    </button>
                                    <span class="text-sm text-gray-600">
                                        ${currentPlaylistIndex + 1} / ${currentPlaylist.length}
                                    </span>
                                    <button onclick="nextTrack()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                        Suivant ‚è≠Ô∏è
                                    </button>
                                </div>
                                <div class="mt-2 text-center">
                                    <a href="${currentPlaylist[0].originalSrc}" target="_blank" rel="noopener noreferrer" 
                                       class="text-blue-600 hover:text-blue-800 text-sm underline">
                                        üì• T√©l√©charger ce fichier
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <h3 class="font-medium text-gray-900 mb-3">Liste des morceaux :</h3>
                            ${currentPlaylist.map((track, index) => `
                                <div class="flex items-center justify-between p-3 rounded-lg cursor-pointer hover:bg-gray-50 ${index === currentPlaylistIndex ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'bg-gray-50'}" 
                                     onclick="playTrack(${index})">
                                    <div class="flex items-center">
                                        <span class="text-sm text-gray-500 mr-3">${index + 1}.</span>
                                        <span class="font-medium">${track.title}</span>
                                        ${index === currentPlaylistIndex ? '<span class="ml-2 text-yellow-600">‚ñ∂Ô∏è</span>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            playlistModal = modal;
            
            // Setup audio event listeners
            const audio = document.getElementById('playlistAudio');
            currentAudio = audio;
            
            audio.addEventListener('ended', () => {
                nextTrack();
            });
            
            audio.addEventListener('error', (e) => {
                console.error('Erreur de lecture audio:', e);
                alert('Erreur lors de la lecture. V√©rifiez que le fichier est accessible publiquement sur Google Drive.');
            });
        }

        function closePlaylistModal() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if (playlistModal) {
                document.body.removeChild(playlistModal);
                playlistModal = null;
            }
            isPlaylistMode = false;
        }

        function playTrack(index) {
            if (index < 0 || index >= currentPlaylist.length) return;
            
            currentPlaylistIndex = index;
            const track = currentPlaylist[index];
            
            if (currentAudio) {
                currentAudio.src = track.src;
                currentAudio.load();
            }
            
            // Update UI
            const trackInfo = document.getElementById('currentTrackInfo');
            if (trackInfo) {
                trackInfo.textContent = track.title;
            }
            
            // Update download link
            const downloadLink = playlistModal.querySelector('a[href*="drive.google.com"]');
            if (downloadLink) {
                downloadLink.href = track.originalSrc;
            }
            
            // Update playlist highlighting
            document.querySelectorAll('#playlistModal .cursor-pointer').forEach((item, i) => {
                if (i === index) {
                    item.className = item.className.replace('bg-gray-50', 'bg-yellow-50 border-l-4 border-yellow-400');
                    if (!item.innerHTML.includes('‚ñ∂Ô∏è')) {
                        item.innerHTML = item.innerHTML.replace('</div>', '<span class="ml-2 text-yellow-600">‚ñ∂Ô∏è</span></div>');
                    }
                } else {
                    item.className = item.className.replace('bg-yellow-50 border-l-4 border-yellow-400', 'bg-gray-50');
                    item.innerHTML = item.innerHTML.replace('<span class="ml-2 text-yellow-600">‚ñ∂Ô∏è</span>', '');
                }
            });
            
            // Update counter
            const counter = playlistModal.querySelector('.text-sm.text-gray-600');
            if (counter) {
                counter.textContent = `${currentPlaylistIndex + 1} / ${currentPlaylist.length}`;
            }
        }

        function nextTrack() {
            if (currentPlaylistIndex < currentPlaylist.length - 1) {
                playTrack(currentPlaylistIndex + 1);
            } else {
                // Loop back to first track
                playTrack(0);
            }
        }

        function previousTrack() {
            if (currentPlaylistIndex > 0) {
                playTrack(currentPlaylistIndex - 1);
            } else {
                // Go to last track
                playTrack(currentPlaylist.length - 1);
            }
        }

        // Listen to song function for library
        function listenToSong(songId) {
            const song = songs.find(s => s.id === songId);
            if (!song || !song.audios) {
                alert('Aucun enregistrement disponible pour ce morceau.');
                return;
            }
            
            // Create playlist from all available voices in the song
            currentPlaylist = [];
            Object.keys(song.audios).forEach(voice => {
                if (song.audios[voice] && song.audios[voice].trim() !== '') {
                    currentPlaylist.push({
                        title: `${song.name} - ${getVoiceName(voice)}`,
                        src: convertGoogleDriveLink(song.audios[voice]),
                        originalSrc: song.audios[voice],
                        songName: song.name,
                        voice: voice
                    });
                }
            });
            
            if (currentPlaylist.length === 0) {
                alert('Aucun enregistrement disponible pour ce morceau.');
                return;
            }
            
            currentPlaylistIndex = 0;
            isPlaylistMode = true;
            showPlaylistModal(`√âcoute - ${song.name}`);
        }

        // Initialize the app
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98207766f658556d',t:'MTc1ODM2MjMyOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
